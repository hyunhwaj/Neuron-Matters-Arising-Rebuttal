---
title: "Comparison of EdgeR and Voom+limma on zero inflated low counts data"
output: html_document
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Import libraries and data.
```{r message=FALSE, warning=FALSE}
library(edgeR)
library(DESeq2)
library(ggplot2)
library(knitr)
load("data.Rdata")
interests <- c("NC_001716.2_region_1_153080__ID=id0", "NC_001664.2_region_1_159322__ID=id0")
```

Data variables include, `data.Rdata` contains four variables - `virMat` (read counts), `fullReadsPerSample` (library size), `comparison_annot` (condition and covariates), and `interests`.
```{r}
ls()
```


A summary of the condition and covariates used in this analysis.

```{r}
summary(comparison_annot)
```

The following plot shows the count distributions of viruses in questions.
```{r}
df_int <- 
  rbind(
    data.frame(id = interests[1], count = unlist(virMat[interests[1],]), status = comparison_annot$status),
    data.frame(id = interests[2], count = unlist(virMat[interests[2],]), status = comparison_annot$status)
  )
ggplot(df_int, aes(x=count)) + 
  geom_histogram(aes(fill=status)) + facet_wrap(status~id, scales = "free_y")
```

The following function produces a result of DE using `voom + Limma`.
```{r}
run_voom <- function(virMat, fullReadsPerSample, comparison_annot) {
  # create a design matrix and a contrast matrix for the DE analysis
  designMat = model.matrix( ~ 0 + status + AOD + Race + RIN + Sex + Batch + PMI ,data = comparison_annot)
  contrast.matrix<-makeContrasts(statusCase-statusControl,levels=designMat)
  
  # identify viruses will be retained in further steps (by read counts)
  sign_threshold_population <- 10
  virMat <- virMat[rowSums(sign(virMat)) > 0,]
  retainVir <- rowSums(virMat >= 2) >= sign_threshold_population
  
  # perform voom and limma
  dge <- DGEList(counts=virMat) 
  v <- voom(dge[retainVir,],designMat, normalize.method = "quantile")
  fit <- lmFit(object = v, design = designMat)
  fit<- contrasts.fit(fit,contrast.matrix)
  fit <- eBayes(fit, robust = TRUE)
  as.data.frame(topTable(fit,number=Inf))
}
```

The following function produces a result of DE using `edgeR`.
```{r}
run_edgeR <- function(virMat, fullReadsPerSample, comparison_annot) {
  # create a design matrix and a contrast matrix for the DE analysis
  designMat = model.matrix( ~ 0 + status + AOD + Race + RIN + Sex + Batch + PMI ,data = comparison_annot)
  contrast.matrix<-makeContrasts(statusCase-statusControl,levels=designMat)
  
  # identify viruses will be retained in further steps (by read counts)
  sign_threshold_population <- 10
  virMat <- virMat[rowSums(sign(virMat)) > 0,]
  retainVir <- rowSums(virMat >= 2) >= sign_threshold_population
  
  # perform edgeR (QL F-test) and return a data.frame
  dge <- DGEList(counts=virMat[retainVir,]) 
  dge <- calcNormFactors(dge)
  dge <- estimateDisp(dge, designMat)
  fit <- glmQLFit(dge, designMat)
  glf <- glmQLFTest(fit,contrast = contrast.matrix)
  as.data.frame(topTags(glf, n = Inf))
}
```

Run functions above and store the results of them.

```{r}
ret_voom <- run_voom(virMat, fullReadsPerSample, comparison_annot)
ret_edgeR <- run_edgeR(virMat, fullReadsPerSample, comparison_annot)
```

`voom` reported our interests are significant.
```{r}
kable(ret_voom[interests,])
```

`edgeR` reported our interests are not significant.
```{r}
kable(ret_edgeR[interests,])
```

Additionally, we performed DE analysis using `DESeq2`, and the following function produces a result of DE using `DESeq2`.

```{r}
run_deseq2 <- function(virMat, fullReadsPerSample, comparison_annot) {
  deseq2_coldata <- comparison_annot
  rownames(deseq2_coldata) <- colnames(virMat)
  sign_threshold_population <- 10
  virMat <- virMat[rowSums(sign(virMat)) > 0,]
  retainVir <- rowSums(virMat >= 2) >= sign_threshold_population
  
  dds <- DESeqDataSetFromMatrix(countData = virMat[retainVir,], 
                                colData = deseq2_coldata, 
                                design = ~ 0 + AOD + Race + RIN + Sex + Batch + PMI + status)
  
  dds <- DESeq(dds)
  as.data.frame(results(dds))
}
```


```{r}
ret_deseq2 <- run_deseq2(virMat, fullReadsPerSample, comparison_annot)
kable(ret_deseq2[interests,])
```
